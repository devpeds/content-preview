<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/default.css">
    <link rel="stylesheet" href="css/preview.css">
    <link rel="stylesheet" href="css/k2-city-guide.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <script src="js/jquery.navgoco.min.js"></script>
    <script src="js/common.js"></script>
    <script>
        const parameters = getParameters();
        const baseUrl = 'https://preview.contentful.com/spaces/' + parameters.space + '/entries/';

        let md;
        require(['https://cdnjs.cloudflare.com/ajax/libs/remarkable/2.0.1/remarkable.min.js'], function (remarkable) {
            md = new remarkable.Remarkable({
                html: true,
                breaks: true,
            });
        });

        //Get entry
        console.log(baseUrl + parameters.entry + '?access_token=' + parameters.access_token)
        fetch(baseUrl + parameters.entry + '?access_token=' + parameters.access_token)
            .then(response => response.json())
            .then(function (entry) {
                getEntries(entry.sys.contentType.sys.id);

                //country
                getCountry(entry.fields.country.sys.id);

                //tagline
                $('#tagline').html('<h2>' + entry.fields.tagline + '</h2>');

                //keyword
                $('#keywords').append('<p></p>');
                const keywords = entry.fields.keywords.split(', ');
                for (let i = 0; i < keywords.length; i++) {
                    if (i < keywords.length - 1) {
                        $('#keywords').children('p').append('#' + keywords[i] + ', ');
                    } else {
                        $('#keywords').children('p').append('#' + keywords[i]);
                    }
                }

                //metaDescription
                $('#metaDescription').append('<p>' + entry.fields.metaDescription + '</p>');

                //intro
                $('#intro').append(md.render(entry.fields.intro));
            });

        //Get country
        function getCountry(entryId) {
            fetch(baseUrl + entryId + '?access_token=' + parameters.access_token)
                .then(response => response.json())
                .then(function (entry) {
                    $('#country').html('<p>' + entry.fields.nameKo + '</p>');
                });
        }

        //Get entries
        function getEntries(contentType) {
            fetch(baseUrl + '?access_token=' + parameters.access_token + '&limit=1000&content_type=' + contentType)
                .then(response => response.json())
                .then(function (entries) {
                    entries.includes.Entry.forEach(function (item) {
                        $('#nav').append('<li id="' + item.fields.nameKo + '"><a href="#">' + item.fields.nameKo + '</a><ul></ul></li>');
                    });

                    let category;
                    let style;
                    entries.items.forEach(function (item) {
                        if (item.fields.country) {
                            category = $('#' + item.fields.country.sys.id);
                            if (parameters.entry == item.sys.id) {
                                style = 'active';
                                category.addClass(style);
                            } else style = '';

                            category.children('ul').append('<li class="' + style + '"><a href="?space=' + parameters.space + "&entry=" + item.sys.id + '&access_token=' + parameters.access_token + '">' + item.fields.cityNameKo + '</a></li>');
                        }
                    });

                    $('#nav').navgoco({
                        caretHtml: '',
                        accordion: false,
                        openClass: 'active',
                        save: false,
                        slide: {
                            duration: 400,
                            easing: 'swing'
                        }
                    });
                });
        }
    </script>
</head>
<body>
<div id="container">
    <ul id="nav">최근 1000개 까지 표시됩니다.</ul>
    <div id='content'>
        <div id='country'></div>
        <div id='tagline'></div>
        <div id='keywords'></div>
        <div id='metaDescription'></div>
        <hr>
        <div id='intro'></div>
        <hr>
    </div>
</div>
</body>
</html>
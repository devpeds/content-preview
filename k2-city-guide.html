<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/k2-city-guide.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.3.4/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <script src="js/jquery.navgoco.min.js"></script>
    <script src="js/common.js"></script>
    <script>
        const parameters = getParameters();
        const baseUrl = 'https://preview.contentful.com/spaces/' + parameters.space + '/entries/';
        
        let md;
        require(['https://cdnjs.cloudflare.com/ajax/libs/remarkable/2.0.1/remarkable.min.js'], function (remarkable) {
            md = new remarkable.Remarkable({
                html: true,
                breaks: true,
            });
        });

        //Get entry
        fetch(baseUrl + parameters.entry + '?access_token=' + parameters.access_token)
            .then(response => response.json())
            .then(function (entry) {
                const fields = entry.fields;


                console.log(baseUrl + parameters.entry + '?access_token=' + parameters.access_token);
                getEntries(entry.sys.contentType.sys.id);

                //country
                getCountry(fields.country.sys.id, fields.cityCodeEtp, fields.cityNameKo);

                //keyword
                $('#keywords').append('<p></p>');
                const keywords = fields.keywords.split(', ');
                for (let i = 0; i < keywords.length; i++) {
                    $('#keywords').children('p').append('#' + keywords[i] + ' ');
                }

                //intro
                $('#intro').append('<h2>' + fields.tagline + '</h2>');
                $('#intro').append(md.render(fields.intro));
                // 더보기 버튼 $('#intro').append('<button onclick="#" class="outline"><i class="ri-download-line"></i> 더보기</button>'); 

                //routes
                $('#routes').prepend('<h3>한국에서 ' + fields.cityNameKo + '까지</h3>');
                $('#routes-list').append('<p>' + fields.routes[0].departure + '</p><p class="box"><i class="ri-plane-line"></i> hh시간 mm분 비행</p>');
                $('#routes-list').append('<p>' + fields.routes[0].arrival + '</p>');
                const landmark = fields.landmark;
                switch (landmark.transportation) { 
                    case "Flight":
                        $('#routes-list').append('<p class="box"><i class="ri-plane-line"></i>' + landmark.description + '</p>');
                        break;

                    case "Boat":
                        $('#routes-list').append('<p class="box"><i class="ri-ship-line"></i>' + landmark.description + '</p>');
                        break;

                    case "Train":
                        $('#routes-list').append('<p class="box"><i class="ri-train-line"></i>' + landmark.description + '</p>');
                        break;

                    case "Subway":
                        $('#routes-list').append('<p class="box"><i class="ri-subway-line"></i>' + landmark.description + '</p>');
                        break;

                    case "Bus":
                        $('#routes-list').append('<p class="box"><i class="ri-bus-line"></i>' + landmark.description + '</p>');
                        break;
                        
                    case "Car":
                        $('#routes-list').append('<p class="box"><i class="ri-roadster-line"></i>' + landmark.description + '</p>');
                        break;
                        
                    case "Tram":
                        $('#routes-list').append('<p class="box"><i class="ri-train-line"></i>' + landmark.description + '</p>');
                        break;
                        
                    case "Walk":
                        $('#routes-list').append('<p class="box"><i class="ri-walk-line"></i>' + landmark.description + '</p>');
                        break;
                }
                $('#routes-list').append('<p>' + landmark.name + '</p>');
            
                //phrases
                $('#phrases').prepend('<h3>이 단어만 알아도 현지인</h3>')
                for (let i = 0; i < fields.phrases.length; i++){
                    $('#phrases-container').append('<div class="phrases"><p>' + fields.phrases[i].key + '</p><p>' + fields.phrases[i].value + '</p></div>');
                }

                //weather
                $('#weather').prepend('<h3>오늘의 ' + fields.cityNameKo + '날씨</h3>');
                for (let i = 0; i < fields.specialDates.length; i++){
                    if (fields.specialDates[i].type === "season"){
                        $('#season').append('<div><i class="ri-pushpin-line"></i><h5>' + fields.specialDates[i].description + '</h5><p>' + fields.specialDates[i].startMonth + '월~' + fields.specialDates[i].endMonth + '월</p></div>');
                    }
                    if (entry.fields.specialDates[i].type === "avoidingSeason"){
                        $('#season').append('<div><i class="ri-pushpin-fill"></i><h5>' + fields.specialDates[i].description + '</h5><p>' + fields.specialDates[i].startMonth + '월~' + fields.specialDates[i].endMonth + '월</p></div>');
                    }
                }

                //info
                $('#info').prepend('<h3>' + fields.cityNameKo + ' 알아가기</h3>')
                $('#info-container').append('<div><i class="ri-translate-2"></i><h4>' + fields.languages[0].mainText + '</h4><p>' + fields.languages[0].subText + '</p></div>');
                $('#info-container').append('<div><i class="ri-empathize-line"></i><h4>' + '종교' + '</h4><p>' + fields.religions + '</p></div>');
                
                fetch(baseUrl + fields.country.sys.id + '?access_token=' + parameters.access_token)
                    .then(function(response) {return response.json();})
                    .then(function(entry) {
                        const countryCurrencies = entry.fields.currencies;
                        const countryElectricity = entry.fields.electricity;
                        const countryTipping = entry.fields.tipping;
                        const countryVisa = entry.fields.visa;

                        if (fields.currencies){
                            $('#info-container').append('<div><i class="ri-money-dollar-circle-line"></i><h4>' + '통화' + '</h4><p>' + fields.currencies + '</p></div>');
                        } else {
                            if (countryCurrencies){
                                $('#info-container').append('<div><i class="ri-money-dollar-circle-line"></i><h4>' + '통화' + '</h4><p>' + countryCurrencies + '</p></div>');
                            };
                        }

                        if (fields.electricity){
                            $('#info-container').append('<div><i class="ri-plug-line"></i><h4>' + '전압' + '</h4><p>' + fields.electricity + '</p></div>');
                        } else {
                            if (countryElectricity){
                                $('#info-container').append('<div><i class="ri-plug-line"></i><h4>' + '전압' + '</h4><p>' + countryElectricity + '</p></div>');
                            };
                        }

                        if (fields.tipping){
                            $('#info-container').append('<div><i class="ri-hand-coin-line"></i><h4>' + '팁 문화' + '</h4><p>' + fields.tipping + '</p></div>');
                        } else {
                            if (countryTipping){
                                $('#info-container').append('<div><i class="ri-hand-coin-line"></i><h4>' + '팁 문화' + '</h4><p>' + countryTipping + '</p></div>');
                            };
                        }

                        if (fields.visa){
                            $('#info-container').append('<div><i class="ri-global-line"></i><h4>' + '비자' + '</h4><p>' + fields.visa + '</p></div>');
                        } else {
                            if (countryVisa){
                                $('#info-container').append('<div><i class="ri-global-line"></i><h4>' + countryVisa[0].mainText + '</h4><p>' + countryVisa[0].subText + '</p></div>');
                            };
                        }

                        if (fields.callingCode){
                            $('#info-container').append('<div><i class="ri-phone-line"></i><h4>' + '국가번호' + '</h4><p>' + fields.callingCode + '</p></div>');
                        };
                        
                });

                //articles
                $('#articles').prepend('<h3>' + fields.cityNameKo + ' 언제갈까요?</h3>');
                var imgUrl;
                for (let i = 0; i < fields.articles.length; i++) {
                    if (fields.articles[i].imageUrl){
                        imgUrl = fields.articles[i].imageUrl;
                    } else {
                        imgUrl = "https://res.cloudinary.com/kyte/image/upload/v1593414810/cities/default-img.jpg";
                    };
                    $('.slide-wrapper').append('<div class="slide"><img src=' + imgUrl + '><h4>' + fields.articles[i].title + '</h4><p>' + fields.articles[i].description + '</p></div>');
                };

                //articles Slide
                var slideContainer = document.getElementsByClassName('slide-container');
                var slideWrapper = document.getElementsByClassName('slide-wrapper');
                var slides = document.getElementsByClassName('slide');
                var currentIndex = 0;
                var topHeight = 0;
                var slideWidth = slides[0].offsetWidth;
                var prev = document.getElementById('prev');
                var next = document.getElementById('next');
            
                for (var i = 0; i < slides.length; i++) {
                    if (slides[i].offsetHeight > topHeight){
                        topHeight = slides[i].offsetHeight;
                    }                
                }
                slideContainer[0].style.height = topHeight + 'px';
                slideWrapper[0].style.height = topHeight + 'px';

                for (var i = 0; i < slides.length; i++) {
                    slides[i].style.left = i * slideWidth + 'px';
                    slides[i].style.width = slideWidth + 'px';
                }

                function moveSlide(i){
                    slideWrapper[0].style.left = i * -100 + '%';
                    slideWrapper[0].classList.add('animated');
                    currentIndex = i;
                    updateNav();
                }

                function updateNav(){
                    if (currentIndex == 0) { 
                        prev.classList.add('disabled');
                    } else {
                        prev.classList.remove('disabled');
                    } 
                    
                    if (currentIndex == slides.length - 1){
                        next.classList.add('disabled');
                    } else {
                        next.classList.remove('disabled');
                    }
                }

                prev.addEventListener('click', function(){
                    moveSlide(currentIndex - 1);
                })

                next.addEventListener('click', function(){
                    moveSlide(currentIndex + 1);
                })

                moveSlide(0);

            });

        //Get country
        function getCountry(entryId, cityCodeEtp, cityNameKo) {
            fetch(baseUrl + entryId + '?access_token=' + parameters.access_token)
                .then(response => response.json())
                .then(function (entry) {
                    console.log(baseUrl + entryId + '?access_token=' + parameters.access_token)

                    //cityImage
                    $('#cityImage').append('<img src=https://res.cloudinary.com/kyte/image/upload/IATA/locations/' + entry.fields.code + '/' + cityCodeEtp + '_0.jpg>');

                    $('#tagline').append('<h1><small>' + entry.fields.nameKo + '</small></h1>' + '<h1>' + cityNameKo + '</h1>');

                });
        }

        //Get entries
        function getEntries(contentType) {
            fetch(baseUrl + '?access_token=' + parameters.access_token + '&limit=1000&content_type=' + contentType)
                .then(response => response.json())
                .then(function (entries) {
                    entries.includes.Entry.forEach(function (item) {
                        $('#nav').append('<li id="' + item.sys.id + '"><a href="#">' + item.fields.nameKo + '</a><ul></ul></li>');
                    });


                    let category;
                    let style;
                    entries.items.forEach(function (item) {
                        if (item.fields.country) {
                            category = $('#' + item.fields.country.sys.id);
                            if (parameters.entry == item.sys.id) {
                                style = 'active';
                                category.addClass(style);
                                category.addClass('open');
                            } else style = '';

                            category.children('ul').append('<li class="' + style + '"><a href="?space=' + parameters.space + "&entry=" + item.sys.id + '&access_token=' + parameters.access_token + '">' + item.fields.cityNameKo + '</a></li>');
                        }
                    });

                    $('#nav').navgoco({
                        caretHtml: '',
                        accordion: false,
                        openClass: 'open',
                        save: false,
                        slide: {
                            duration: 400,
                            easing: 'swing'
                        }
                    });
                });
        }
        
    </script>

</head>
<body>
<div id="container">
    <ul id="nav">최근 1000개 까지 표시됩니다.</ul>
    <div id='content'>
        <div id='cityImage'></div>
        <div id='tagline'></div>
        <div id='keywords'></div>
        <div id='intro'></div>
        <hr>
        <div id='routes'>
            <div id="routes-con">
                <div id="routes-line">
                    <div class="dot-box">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <div class="line"></div>
                    <!-- <div class="line"></div> -->
                </div>
                <div id="routes-list"></div>
            </div>
        </div>
        <hr>
        <div id='phrases'>
            <div id="phrases-container"></div>
        </div>
        <hr>
        <div id="weather">
            <div id="season"></div>
        </div>
        <hr>
        <div id="info">
            <div id="info-container"></div>
        </div>
        <hr>
        <div id='articles'>
            <div class="slide-container">
                <div class="slide-wrapper"></div>
                <div id="prev"><i class="ri-arrow-left-s-line"></i></div>
                <div id="next"><i class="ri-arrow-right-s-line"></i></div>
            </div>
        </div>
        <hr>
    </div>
</div>
</body>
</html>
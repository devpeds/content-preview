<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/k2-default.css">
    <link rel="stylesheet" href="css/preview.css">
    <link rel="stylesheet" href="css/k2-city-guide.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <script src="js/jquery.navgoco.min.js"></script>
    <script src="js/common.js"></script>
    <script>
        const parameters = getParameters();
        const baseUrl = 'https://preview.contentful.com/spaces/' + parameters.space + '/entries/';
        

        let md;
        require(['https://cdnjs.cloudflare.com/ajax/libs/remarkable/2.0.1/remarkable.min.js'], function (remarkable) {
            md = new remarkable.Remarkable({
                html: true,
                breaks: true,
            });
        });

        //Get entry
        fetch(baseUrl + parameters.entry + '?access_token=' + parameters.access_token)
            .then(response => response.json())
            .then(function (entry) {
                getEntries(entry.sys.contentType.sys.id);

                console.log(baseUrl + parameters.entry + '?access_token=' + parameters.access_token);

                //country
                getCountry(entry.fields.country.sys.id, entry.fields.cityCodeEtp, entry.fields.tagline);

                //keyword
                $('#keywords').append('<p></p>');
                const keywords = entry.fields.keywords.split(', ');
                for (let i = 0; i < keywords.length; i++) {
                    $('#keywords').children('p').append('#' + keywords[i] + ' ');
                }

                //metaDescription
                $('#metaDescription').append('<p>' + entry.fields.metaDescription + '</p>');

                //intro
                $('#intro').append('<h3>' + entry.fields.cityNameKo + ' 소개</h3>');
                $('#intro').append(md.render(entry.fields.intro));
                // $('#intro').append('<button onclick="#" class="outline"><i class="ri-download-line"></i> 더보기</button>');

                //routes
                $('#routes-tit').append('<h3>한국에서 ' + entry.fields.cityNameKo + '까지</h3>');
                $('#routes-list').append('<p>' + entry.fields.routes[0].departure + '</p>');
                $('#routes-list').append('<p class="box"><i class="ri-plane-line"></i> hh시간 mm분 비행</p>');
                $('#routes-list').append('<p>' + entry.fields.routes[0].arrival + '</p>');
                switch (entry.fields.landmark.transportation) { 
                    case "Flight":
                        $('#routes-list').append('<p class="box"><i class="ri-plane-line"></i>' + entry.fields.landmark.description + ' </p>');
                        break;

                    case "Boat":
                        $('#routes-list').append('<p class="box"><i class="ri-ship-line"></i>' + entry.fields.landmark.description + '</p>');
                        break;

                    case "Train":
                        $('#routes-list').append('<p class="box"><i class="ri-train-line"></i>' + entry.fields.landmark.description + '</p>');
                        break;

                    case "Subway":
                        $('#routes-list').append('<p class="box"><i class="ri-subway-line"></i>' + entry.fields.landmark.description + '</p>');
                        break;

                    case "Bus":
                        $('#routes-list').append('<p class="box"><i class="ri-bus-line"></i>' + entry.fields.landmark.description + '</p>');
                        break;
                        
                    case "Car":
                        $('#routes-list').append('<p class="box"><i class="ri-roadster-line"></i>' + entry.fields.landmark.description + '</p>');
                        break;
                        
                    case "Tram":
                        $('#routes-list').append('<p class="box"><i class="ri-train-line"></i>' + entry.fields.landmark.description + '</p>');
                        break;
                        
                    case "Walk":
                        $('#routes-list').append('<p class="box"><i class="ri-walk-line"></i>' + entry.fields.landmark.description + '</p>');
                        break;
                }
                $('#routes-list').append('<p>' + entry.fields.landmark.name + '</p>');
            

                //phrases
                $('#phrases-tit').append('<h3>이 단어만 알아도 현지인</h3>')
                for (let i=0; i < entry.fields.phrases.length; i++){
                    $('#phrases').append('<p>' + entry.fields.phrases[i].key + '</p>');
                    $('#phrases').append('<p>' + entry.fields.phrases[i].value + '</p>');
                }

                //articles
                $('#articles-tit').append('<h3>' + entry.fields.cityNameKo + ' 언제갈까요?</h3>');
                var slidesCounter = entry.fields.articles.length;

                for (let i=0; i < slidesCounter; i++){
                        var addDiv = document.createElement('div');
                        addDiv.innerHTML = ('<img src=' + entry.fields.articles[i].imageUrl + '><p>' + entry.fields.articles[i].title + '</p><p>' + entry.fields.articles[i].description + '</p>');
                        var getArticles = document.querySelector('.slide-wrapper').appendChild(addDiv);
                        $(getArticles).addClass('slide');
                }

                var slideContainer = document.getElementsByClassName('slide-container');
                var slideWrapper = document.getElementsByClassName('slide-wrapper');
                var slides = document.getElementsByClassName('slide');
                var slideCount = slides.length;
                var currentIndex = 0;
                var topHeight = 0;
                var slideWidth = slides[0].offsetWidth;
            
                function calcTallest(){
                    for(var i=0; i < slideCount; i++){
                        if(slides[i].offsetHeight > topHeight){
                            topHeight = slides[i].offsetHeight;
                        }
                    }
                    slideContainer[0].style.height = topHeight + 'px';
                    slideWrapper[0].style.height = topHeight + 'px';
                }
                calcTallest();

                for(var i=0; i < slideCount; i++){
                    slides[i].style.left = i * slideWidth + 'px';
                    slides[i].style.width = slideWidth + 'px';
                }
                

            });

        //Get country
        function getCountry(entryId, cityCodeEtp, tagline) {
            fetch(baseUrl + entryId + '?access_token=' + parameters.access_token)
                .then(response => response.json())
                .then(function (entry) {
                    console.log(baseUrl + entryId + '?access_token=' + parameters.access_token)

                    //cityImage
                    $('#cityImage').append('<img src=https://res.cloudinary.com/kyte/image/upload/IATA/locations/' + entry.fields.code + '/' + cityCodeEtp + '_0.jpg>');

                    //tagline
                    $('#tagline').append('<h2><small>' + entry.fields.nameKo + '</small></h2>' + '<h2>' + tagline + '</h2>');
                });
        }

        //Get entries
        function getEntries(contentType) {
            fetch(baseUrl + '?access_token=' + parameters.access_token + '&limit=1000&content_type=' + contentType)
                .then(response => response.json())
                .then(function (entries) {
                    entries.includes.Entry.forEach(function (item) {
                        $('#nav').append('<li id="' + item.sys.id + '"><a href="#">' + item.fields.nameKo + '</a><ul></ul></li>');
                    });

                    let category;
                    let style;
                    entries.items.forEach(function (item) {
                        if (item.fields.country) {
                            category = $('#' + item.fields.country.sys.id);
                            if (parameters.entry == item.sys.id) {
                                style = 'active';
                                category.addClass(style);
                                category.addClass('open');
                            } else style = '';

                            category.children('ul').append('<li class="' + style + '"><a href="?space=' + parameters.space + "&entry=" + item.sys.id + '&access_token=' + parameters.access_token + '">' + item.fields.cityNameKo + '</a></li>');
                        }
                    });

                    $('#nav').navgoco({
                        caretHtml: '',
                        accordion: false,
                        openClass: 'open',
                        save: false,
                        slide: {
                            duration: 400,
                            easing: 'swing'
                        }
                    });
                });
        }
        
    </script>

</head>
<body>
<div id="container">
    <ul id="nav">최근 1000개 까지 표시됩니다.</ul>
    <div id='content'>
        <div id='cityImage'></div>
        <div id='tagline'></div>
        <div id='keywords'></div>
        <div id='metaDescription'></div>
        <hr>
        <div id='intro'></div>
        <hr>
        <div id='routes'>
            <div id="routes-tit"></div>
            <div id="routes-con">
                <div id="routes-line">
                    <div class="dot-box">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <div class="line"></div>
                    <!-- <div class="line"></div> -->
                </div>
                <div id="routes-list"></div>
            </div>
        </div>
        <hr>
        <div id='phrases'>
            <div id="phrases-tit"></div>
        </div>
        <hr>
        <div id='articles'>
            <div id="articles-tit"></div>
            <div class="slide-container">
                <div class="slide-wrapper"></div>  
            </div>
        </div>
    </div>
</div>

</body>
</html>

